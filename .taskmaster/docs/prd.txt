# Intelligent Pipeline Inspection (ILI) Data Alignment & Corrosion Growth Prediction

## Overview
Backend/data pipeline for automated ILI run alignment, anomaly matching, and corrosion growth prediction. NO FRONTEND — outputs are clean CSVs/JSON that a UI (Figma) consumes later.

## Context
ILI "smart pigs" inspect pipelines every 5–10 years. Each run reports the same physical features at slightly different distances due to odometer drift, speed variation, and reference point differences. Engineers manually align runs by matching fixed control points (girth welds, valves, tees, bends), then match anomalies across runs and compute corrosion growth. This manual process takes weeks.

## Inputs
- Excel workbook: ILIDataV2.xlsx (contains multiple runs, e.g., 2007/2015/2022).
- Start with 2015 vs 2022; optionally add 2007 for multi-run.
- Vendor exports can differ in column names and formats.

## Project Structure (backend-only)
/src
  io.py
  preprocess.py
  alignment.py
  matching.py
  growth.py
  reporting.py
run_pipeline.py
README.md
requirements.txt

## Core MVP Requirements

### 1. Ingest & Column Mapping
- Read Excel/CSV with robust column mapping layer.
- Config dict mapping because exports vary (e.g., "Log Dist [ft]" vs "ILI Wheel Count [ft]").
- Auto-detection routine that inspects sheet columns and selects best mapping.
- Log mapping decisions to alignment_report.json.

### 2. Canonical Schema
Canonical anomalies table with:
- run_id, feature_id, distance, odometer, joint_number, relative_position
- clock_position_raw, clock_deg (parsed numeric)
- feature_type_raw, feature_type_norm
- orientation (ID/OD)
- depth_percent, length, width, wall_thickness

### 3. Control Point Identification
- Identify control points per run (girth welds preferred, plus valves/tees/bends).
- Matching priority: joint_number if available; else ordered sequence + type + spacing.
- Store and write matched/unmatched control points to report.

### 4. Piecewise Linear Alignment
Primary: piecewise linear correction between consecutive matched control points.
For each consecutive pair of matched control points:
  scale = (A1-A0)/(B1-B0)
  shift = A0 - scale*B0
Apply corrected_distance_B = scale*distance_B + shift.
Store per-segment scale/shift, residuals.
Fallback: global affine if insufficient control points.

### 5. Segment-wise Anomaly Matching
- Match per aligned segment (between control points).
- Candidate gating: |delta_distance| <= DIST_TOL, clock_distance <= CLOCK_TOL, compatible type, orientation match.
- Build sparse candidate list (NOT full dense N×M).
- Cost: w_dist*norm(delta_distance) + w_clock*norm(clock_delta) + w_depth*norm(delta_depth) + w_size*norm(delta_length,delta_width) + type_penalty.
- Solve one-to-one per segment with Hungarian (scipy.optimize.linear_sum_assignment).
- Thresholding: best_cost > COST_THRESH => UNCERTAIN; no candidate => unmatched.
- Unmatched Run A => MISSING, Unmatched Run B => NEW.

### 6. Growth Calculations
- depth_growth_pct_per_year = (depth_B - depth_A) / years_between
- length_growth_in_per_year, width_growth_in_per_year
- Handle missing fields gracefully.

### 7. Output Artifacts
- matched_results.csv (RunA fields, RunB fields, corrected_distance, deltas, growth, confidence, status)
- new_anomalies.csv
- missing_anomalies.csv
- alignment_report.json (matched control points, per-segment transforms, residuals, parameters, mapping decisions)

### 8. CLI (run_pipeline.py)
  python run_pipeline.py --file ILIDataV2.xlsx --run_a 2015 --run_b 2022 --outdir outputs/
  Optional: --dist_tol, --clock_tol, --cost_thresh, --years_between, --enable_confidence, --enable_multirun

### 9. README
- One-command run instructions
- Assumptions + parameter defaults
- Alignment + matching + confidence explanation
- Output file definitions
- Troubleshooting

## Stretch Goals (backend-only, after MVP)
A) Confidence scoring: sigmoid-based confidence in [0,1] per match + explainability fields.
B) Multi-run: 3 runs (2007, 2015, 2022), tracks_multi_run.csv with track_id.
C) Performance: segment-wise matching + candidate gating for 10k+ anomalies.

## Non-goals
- NO UI, NO web server, NO Streamlit/Dash/React.
- No deep learning. Deterministic + explainable methods only.
